<!DOCTYPE html>
<html lang="pt-br">
<head>
  <link rel="icon" type="image/x-icon" href="favicon.ico">
</head>
<meta charset="UTF-8">
<title>Gest√£o de Produ√ß√£o</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>

/* ===== BASE ===== */
body {
  margin: 0;
  font-family: 'Segoe UI', Arial, sans-serif;
  background: linear-gradient(135deg, #1e1f23, #2c2c2c);
}

/* ===== TOPBAR ===== */
.topbar {
  display: flex;
  justify-content: flex-end;
  align-items: center;
  background: #1e1f23;
  padding: 12px 30px;
  border-bottom: 3px solid #8b1e23;
}

.user-trigger {
  display: flex;
  align-items: center;
  cursor: pointer;
  gap: 12px;
}

.user-trigger img {
  width: 42px;
  height: 42px;
  border-radius: 50%;
  object-fit: cover;
  border: 2px solid #8b1e23;
}

.user-info {
  color: #f2f2f2;
  font-size: 14px;
  font-weight: 500;
}

/* ===== DROPDOWN ===== */
.dropdown {
  position: absolute;
  right: 30px;
  top: 65px;
  background: #ffffff;
  border-radius: 8px;
  box-shadow: 0 10px 30px rgba(0,0,0,0.35);
  display: none;
  flex-direction: column;
  min-width: 200px;
  overflow: hidden;
}

.dropdown button {
  padding: 12px;
  border: none;
  background: white;
  text-align: left;
  cursor: pointer;
  font-weight: 500;
  transition: 0.2s;
}

.dropdown button:hover {
  background: #f2f2f2;
}

/* ===== CONTAINER MENU ===== */
.menu {
  max-width: 480px;
  margin: 60px auto;
  background: #f2f2f2;
  border-radius: 16px;
  padding: 40px 30px;
  box-shadow: 0 20px 50px rgba(0,0,0,0.4);
  text-align: center;
}

/* ===== LOGO ===== */
.logo-principal {
  width: 220px;
  margin-bottom: 25px;
}

/* ===== T√çTULO ===== */
h2 {
  margin-bottom: 30px;
  color: #1e1f23;
}

/* ===== BOT√ïES ===== */
.menu a {
  display: block;
  padding: 14px;
  margin-top: 14px;
  text-align: center;
  text-decoration: none;
  background: #8b1e23;
  color: #fff;
  font-size: 15px;
  font-weight: 600;
  border-radius: 8px;
  transition: all 0.3s ease;
}

.menu a:hover {
  background: #a5282e;
  transform: translateY(-2px);
}

/* Bot√µes administrativos em tom levemente diferente */
.menu a.grupos {
  background: #2c2c2c;
}

.menu a.grupos:hover {
  background: #3b3b3b;
}

/* ===== RESPONSIVO ===== */
@media (max-width: 600px) {
  .menu {
    margin: 30px 20px;
    padding: 30px 20px;
  }
}

</style>

</head>

<body>

<div class="topbar">
  <div class="user-menu">
    <div class="user-trigger" onclick="toggleUserMenu()">
      <img id="userAvatar" src="https://via.placeholder.com/40" />
      <div class="user-info">
        <span id="usuarioInfo"></span>
      </div>
    </div>

    <div class="dropdown" id="userDropdown">
      <button onclick="abrirPerfil()">Perfil do Usu√°rio</button>
      <button onclick="logout()">Log Off</button>
    </div>
  </div>
</div>

<div class="menu">
  <img src="./imagens/logo_metalurgica.png" class="logo-principal">
  <h2>Gest√£o de Produ√ß√£o</h2>

  <a href="apontamento-planilha.html">
    Apontamento de Produ√ß√£o
  </a>

  <a href="dashboard.html">
    Dashboard de Produ√ß√£o
  </a>

  <a id="linkGrupos" class="grupos" href="grupos.html">
    Cadastro de Grupos
  </a>

  <a id="linkEquipes" class="grupos" href="equipes.html">
    Cadastro de Equipes
  </a>

  <a id="linkCronograma" class="grupos" href="cronograma.html">
    Cadastro de Cronograma
  </a>

  <a id="linkGantt" class="grupos" href="gantt.html">
    Cronograma de Produ√ß√£o
  </a>

  <a id="linkUsuarios" class="grupos" href="usuarios.html">
    Administra√ß√£o de Usu√°rios
  </a>
</div>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

const supabase = createClient(
  "https://dklmejmlovtcadlicnhu.supabase.co",
  "sb_publishable_cpq_meWiczl3c9vpmtKj0w_QOAzH2At"
);

// üîê Verifica sess√£o
const { data: { user } } = await supabase.auth.getUser();

if (!user) {
  window.location.href = "login.html";
}

// üîé Busca perfil
const { data, error } = await supabase
  .from("usuarios_perfil")
  .select("nome, perfil, ativo")
  .eq("id", user.id)
  .single();

if (error) {
    console.error("Erro ao buscar perfil:", error);
    alert("Erro ao carregar perfil do usu√°rio.");
    window.location.href = "login.html";
  }

if (!data) {
  alert("Perfil n√£o encontrado. Contate o administrador.");
  window.location.href = "login.html";
}

const usuarioLogado = {
  id: user.id,
  nome: data?.nome || user.email,
  perfil: data?.perfil || "operador",
  ativo: data?.ativo ?? true
};

if (!usuarioLogado.ativo) {
  alert("Usu√°rio inativo.");
  await supabase.auth.signOut();
  window.location.href = "login.html";
}

// üîê Helper permiss√£o
function temPermissao(perfisPermitidos) {
  return perfisPermitidos.includes(usuarioLogado.perfil);
}

// üë§ Exibir usu√°rio
document.getElementById("usuarioInfo").innerText =
usuarioLogado.nome + " - " + usuarioLogado.perfil.toUpperCase();

  // Dropdown usu√°rio
window.toggleUserMenu = function () {
  const menu = document.getElementById("userDropdown");
  menu.style.display = menu.style.display === "flex" ? "none" : "flex";
};

// Fecha menu ao clicar fora
document.addEventListener("click", function (e) {
  const menu = document.getElementById("userDropdown");
  const trigger = document.querySelector(".user-trigger");

  if (!trigger.contains(e.target)) {
    menu.style.display = "none";
  }
});

// Abrir p√°gina perfil
window.abrirPerfil = function () {
  window.location.href = "perfil.html";
};

// üéØ MENU DIN√ÇMICO

// Supervisor e Admin veem equipes
if (!temPermissao(["admin","supervisor"])) {
  document.getElementById("linkEquipes").style.display = "none";
}

// Somente Admin v√™ grupos e cronograma
if (!temPermissao(["admin"])) {
  document.getElementById("linkGrupos").style.display = "none";
  document.getElementById("linkCronograma").style.display = "none";
  document.getElementById("linkGantt").style.display = "none";
}

// Somente Admin v√™ painel de usu√°rios
if (!temPermissao(["admin"])) {
  document.getElementById("linkUsuarios").style.display = "none";
}

// üö™ Logout
window.logout = async function () {
  await supabase.auth.signOut();
  window.location.href = "login.html";
};
</script>

</body>
</html>
