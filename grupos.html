<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>Cadastro de Grupos de Produ√ß√£o</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body {
  font-family: Arial, sans-serif;
  background: #f2f2f2;
  margin: 20px;
}

h2 {
  margin-bottom: 10px;
}

.bloco {
  background: #ffffff;
  border: 1px solid #cfcfcf;
  padding: 12px;
  margin-bottom: 15px;
}

/* ===== CAMPOS FIXOS ===== */
.campos-fixos {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
  gap: 10px;
}

label {
  font-size: 12px;
  font-weight: bold;
}

input {
  width: 100%;
  padding: 6px;
  font-size: 13px;
  border: 1px solid #bfbfbf;
  box-sizing: border-box;
}

/* ===== PROCESSOS ===== */
.processos {
  display: flex;
  flex-wrap: wrap;
  gap: 15px;
  margin-top: 10px;
}

.processos label {
  font-weight: normal;
  font-size: 13px;
}

/* ===== TABELA PLANILHA ===== */
table {
  width: 100%;
  border-collapse: collapse;
  font-size: 13px;
  background: #fff;
}

th {
  background: #e6e6e6;
  border: 1px solid #bfbfbf;
  padding: 6px;
  text-align: left;
  white-space: nowrap;
}

td {
  border: 1px solid #bfbfbf;
  padding: 0;
}

td input {
  border: none;
  padding: 6px;
  width: 100%;
  font-size: 13px;
  background: transparent;
}

/* ===== BOT√ïES ===== */
.botoes {
  display: flex;
  gap: 10px;
  margin-top: 10px;
}

button {
  padding: 10px;
  font-size: 14px;
  cursor: pointer;
  border: none;
  color: #fff;
}

.btn-add { background: #0070c0; }
.btn-colar { background: #00a6a6; }
.btn-salvar { background: #2e7d32; }

.btn-remover {
  background: #c00000;
  width: 100%;
  height: 100%;
}
</style>
</head>

<body>

<h2>Cadastro de Grupos de Produ√ß√£o</h2>

<!-- ===== CAMPOS FIXOS ===== -->
<div class="bloco">
  <div class="campos-fixos">
    <div>
      <label>Obra</label>
      <input id="obra">
    </div>
    <div>
      <label>Instala√ß√£o</label>
      <input id="instalacao">
    </div>
    <div>
      <label>Estrutura</label>
      <input id="estrutura">
    </div>
    <div>
      <label>Data de Cadastro</label>
      <input type="date" id="dataCadastro">
    </div>
    <div>
      <label>Revis√£o</label>
      <input id="revisao">
    </div>
  </div>

  <!-- ===== PROCESSOS ===== -->
  <div style="margin-top:12px">
    <label>Processos do Grupo</label>
    <div class="processos">
      <label><input type="checkbox" value="Montagem"> Montagem</label>
      <label><input type="checkbox" value="Soldagem"> Soldagem</label>
      <label><input type="checkbox" value="Acabamento"> Acabamento</label>
      <label><input type="checkbox" value="Pintura"> Pintura</label>
      <label><input type="checkbox" value="Entrega"> Entrega</label>
    </div>
  </div>
</div>

<!-- ===== TABELA ===== -->
<div class="bloco">
<table id="grid">
  <thead>
    <tr>
      <th>Conjunto</th>
      <th>Descri√ß√£o</th>
      <th>Qtd.</th>
      <th>Dimens√µes (mm)</th>
      <th>Peso Unit. (kg)</th>
      <th>Peso Total (kg)</th>
      <th>A√ß√£o</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<div class="botoes">
  <button class="btn-add" id="btnAdd">+ Linha</button>
  <button class="btn-colar" id="btnColar">üìã Colar do Excel</button>
  <button class="btn-salvar" id="btnSalvar">Finalizar</button>
</div>
</div>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

/* ===== SUPABASE ===== */
const supabase = createClient(
  "https://dklmejmlovtcadlicnhu.supabase.co",
  "sb_publishable_cpq_meWiczl3c9vpmtKj0w_QOAzH2At"
);

const tbody = document.querySelector("#grid tbody");

/* ===== FUN√á√ïES ===== */
function addLinha(dados = []) {
  const tr = document.createElement("tr");
  tr.innerHTML = `
    <td><input value="${dados[0] || ""}"></td>
    <td><input value="${dados[1] || ""}"></td>
    <td><input type="number" value="${dados[2] || ""}"></td>
    <td><input value="${dados[3] || ""}"></td>
    <td><input type="number" step="0.01" value="${dados[4] || ""}"></td>
    <td><input type="number" step="0.01" value="${dados[5] || ""}"></td>
    <td><button class="btn-remover">üóëÔ∏è</button></td>
  `;
  tr.querySelector(".btn-remover").onclick = () => tr.remove();
  tbody.appendChild(tr);
}

/* ===== COLAR DO EXCEL ===== */
async function colarDoExcel() {
  let texto = "";
  try {
    texto = await navigator.clipboard.readText();
  } catch {
    texto = prompt("Cole os dados do Excel (CTRL + V):");
  }

  if (!texto) return;

  texto.split(/\r?\n/)
    .map(l => l.trim())
    .filter(l => l)
    .forEach(linha => {
      let col = linha.split("\t");
      while (col.length < 6) col.push("");
      col[4] = col[4].replace(",", ".").replace(/\s/g, "");
      col[5] = col[5].replace(",", ".").replace(/\s/g, "");
      addLinha(col);
    });
}

/* ===== SALVAR ===== */
async function salvar() {

  const processosSelecionados = [...document.querySelectorAll(".processos input:checked")]
    .map(c => c.value);

  if (processosSelecionados.length === 0) {
    alert("Selecione pelo menos um processo.");
    return;
  }

  if (!obra.value || !instalacao.value || !estrutura.value || !dataCadastro.value || !revisao.value) {
    alert("Preencha todos os campos fixos.");
    return;
  }

  const registros = [];

  for (const tr of tbody.querySelectorAll("tr")) {
    const i = tr.querySelectorAll("input");
    if (![...i].every(x => x.value)) {
      alert("Todas as linhas da planilha devem estar preenchidas.");
      return;
    }

    registros.push({
      obra: obra.value,
      instalacao: instalacao.value,
      estrutura: estrutura.value,
      data_cadastro: dataCadastro.value,
      revisao: revisao.value,
      processos: processosSelecionados.join(";"),
      conjunto: i[0].value,
      descricao: i[1].value,
      quantidade: i[2].value,
      dimensoes: i[3].value,
      peso_unitario: i[4].value,
      peso_total: i[5].value
    });
  }

  const { error } = await supabase.from("grupos_producao").insert(registros);
  if (error) {
    alert("Erro ao salvar: " + error.message);
    return;
  }

  alert("Grupos cadastrados com sucesso!");

  document.querySelectorAll("input").forEach(i => {
    if (i.type !== "checkbox") i.value = "";
    if (i.type === "checkbox") i.checked = false;
  });

  tbody.innerHTML = "";
  addLinha();
}

/* ===== EVENTOS ===== */
btnAdd.onclick = () => addLinha();
btnColar.onclick = colarDoExcel;
btnSalvar.onclick = salvar;

/* LINHA INICIAL */
addLinha();
</script>

</body>
</html>
