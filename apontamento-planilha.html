<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>Apontamento de Produ√ß√£o</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body { font-family: Arial, sans-serif; margin: 10px; background: #f4f6f8; }
h2 { text-align: center; }

.topo, .tabela {
  background: #fff;
  padding: 12px;
  border-radius: 6px;
  margin-bottom: 12px;
  box-shadow: 0 1px 4px rgba(0,0,0,0.1);
}

.linha-topo {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
  gap: 10px;
}

label { font-size: 13px; font-weight: bold; }

input, select {
  width: 100%;
  padding: 10px;
  font-size: 15px;
  box-sizing: border-box;
}

table {
  width: 100%;
  border-collapse: collapse;
  font-size: 13px;
}

th, td {
  border: 1px solid #ccc;
  padding: 6px;
}

th { background: #eee; white-space: nowrap; }

.acoes {
  margin-top: 10px;
  display: flex;
  gap: 10px;
}

.acoes button {
  padding: 12px;
  flex: 1;
  font-size: 15px;
  border: none;
  border-radius: 4px;
  cursor: pointer;
}

.add { background: #0275d8; color: white; }
.finalizar { background: #2e7d32; color: white; }
.remover {
  background: #d9534f;
  color: white;
  border: none;
  padding: 6px 10px;
  cursor: pointer;
  border-radius: 4px;
}

/* RESPONSIVO MOBILE */
@media (max-width: 768px) {

  table thead { display: none; }

  table, tbody, tr, td {
    display: block;
    width: 100%;
  }

  tr {
    margin-bottom: 12px;
    background: #fff;
    padding: 10px;
    border-radius: 6px;
  }

  td {
    border: none;
    margin-bottom: 8px;
  }

  .acoes {
    position: sticky;
    bottom: 0;
    background: #fff;
    padding: 10px;
  }
}
</style>
</head>

<body>

<h2>Apontamento de Produ√ß√£o</h2>

<div class="topo">
  <div class="linha-topo">
    <div><label>Data</label><input type="date" id="data"></div>

    <div>
      <label>Processo</label>
      <select id="processo">
        <option value="">Selecione</option>
        <option>Montagem</option>
        <option>Soldagem</option>
        <option>Acabamento</option>
        <option>Pintura</option>
        <option>Entrega</option>
      </select>
    </div>

    <div><label>F√°brica</label><input id="fabrica"></div>
    <div><label>Fornecedor</label><input id="fornecedor"></div>
  </div>
</div>

<div class="tabela">
<table id="grid">
<thead>
<tr>
<th>Equipe</th>
<th>Obra</th>
<th>Instala√ß√£o</th>
<th>Estrutura</th>
<th>Conjunto</th>
<th>Descri√ß√£o</th>
<th>Qtde</th>
<th>J√° Produzido</th>
<th>A√ß√£o</th>
</tr>
</thead>
<tbody></tbody>
</table>

<div class="acoes">
<button class="add" onclick="addLinha()">+ Linha</button>
<button class="finalizar" onclick="validarEFinalizar()">Finalizar</button>
</div>
</div>

<div class="tabela">
  <h3>Apontamentos j√° lan√ßados</h3>
  <div id="historicoContainer">
    <p style="color:#666;">Selecione data e processo para visualizar.</p>
  </div>
</div>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

const supabase = createClient(
  "https://dklmejmlovtcadlicnhu.supabase.co",
  "sb_publishable_cpq_meWiczl3c9vpmtKj0w_QOAzH2At"
);

const tbody = document.querySelector("#grid tbody");
let registrosPendentes = [];

/* ============================
   UTIL
============================ */
function unique(arr) {
  return [...new Set(arr.filter(Boolean))];
}

function preencherSelect(select, valores, placeholder = "Selecione") {
  select.innerHTML = "";

  const optPadrao = document.createElement("option");
  optPadrao.value = "";
  optPadrao.textContent = placeholder;
  optPadrao.selected = true;
  select.appendChild(optPadrao);

  unique(valores).forEach(v => {
    const opt = document.createElement("option");
    opt.value = v;
    opt.textContent = v;
    select.appendChild(opt);
  });

  select.disabled = false;
}

function resetSelect(select) {
  select.innerHTML = `<option value="">Selecione</option>`;
  select.disabled = true;
}

/* ============================
   CARREGAR EQUIPES + OBRAS
============================ */
async function carregarBase(tr) {

  const selEquipe = tr.querySelector(".equipe");
  const selObra = tr.querySelector(".obra");

  const { data: equipes } = await supabase
    .from("equipes_producao")
    .select("nome");

  preencherSelect(selEquipe, equipes.map(e => e.nome));

  const { data: obras } = await supabase
    .from("grupos_producao")
    .select("obra");

  preencherSelect(selObra, obras.map(o => o.obra));
}

/* ============================
   LINHA
============================ */
function addLinha() {

  const tr = document.createElement("tr");
  tr.innerHTML = `
    <td><select class="equipe"></select></td>
    <td><select class="obra"></select></td>
    <td><select class="instalacao" disabled></select></td>
    <td><select class="estrutura" disabled></select></td>
    <td><select class="conjunto" disabled></select></td>
    <td><input class="descricao" disabled></td>
    <td><input type="number" class="quantidade" min="1"></td>
    <td><input class="produzido" disabled value="0"></td>
    <td><button class="remover" onclick="this.closest('tr').remove()">üóëÔ∏è</button></td>
  `;

  tbody.appendChild(tr);
  configurarEventos(tr);
  carregarBase(tr);
}

/* ============================
   EVENTOS CASCADE
============================ */
function configurarEventos(tr) {

  const obra = tr.querySelector(".obra");
  const instalacao = tr.querySelector(".instalacao");
  const estrutura = tr.querySelector(".estrutura");
  const conjunto = tr.querySelector(".conjunto");
  const descricao = tr.querySelector(".descricao");

  obra.addEventListener("change", async () => {

    resetSelect(instalacao);
    resetSelect(estrutura);
    resetSelect(conjunto);
    descricao.value = "";

    if (!obra.value) return;

    const { data } = await supabase
      .from("grupos_producao")
      .select("instalacao")
      .eq("obra", obra.value);

    preencherSelect(instalacao, data.map(d => d.instalacao));
  });

  instalacao.addEventListener("change", async () => {

    resetSelect(estrutura);
    resetSelect(conjunto);
    descricao.value = "";

    if (!instalacao.value) return;

    const { data } = await supabase
      .from("grupos_producao")
      .select("estrutura")
      .eq("obra", obra.value)
      .eq("instalacao", instalacao.value);

    preencherSelect(estrutura, data.map(d => d.estrutura));
  });

  estrutura.addEventListener("change", async () => {

    resetSelect(conjunto);
    descricao.value = "";

    if (!estrutura.value) return;

    const { data } = await supabase
      .from("grupos_producao")
      .select("conjunto")
      .eq("obra", obra.value)
      .eq("instalacao", instalacao.value)
      .eq("estrutura", estrutura.value);

    preencherSelect(conjunto, data.map(d => d.conjunto));
  });

  conjunto.addEventListener("change", async () => {

    if (!conjunto.value) return;

    const { data } = await supabase
      .from("grupos_producao")
      .select("descricao")
      .eq("obra", obra.value)
      .eq("instalacao", instalacao.value)
      .eq("estrutura", estrutura.value)
      .eq("conjunto", conjunto.value)
      .limit(1);

    if (data?.length) descricao.value = data[0].descricao;
  });
}

/*CARREGAR HIST√ìRICO*/

async function carregarHistorico() {

  const dataSelecionada = data.value;
  const processoSelecionado = processo.value;

  const container = document.getElementById("historicoContainer");

  if (!dataSelecionada || !processoSelecionado) {
    container.innerHTML = `<p style="color:#666;">Selecione data e processo para visualizar.</p>`;
    return;
  }

  const { data: registros, error } = await supabase
    .from("apontamentos")
    .select("fabrica, fornecedor, obra, instalacao, estrutura, conjunto, quantidade")
    .eq("processo", processoSelecionado)
    .gte("data", dataSelecionada + "T00:00:00")
    .lte("data", dataSelecionada + "T23:59:59");

  if (error) {
    container.innerHTML = `<p style="color:red;">Erro ao carregar hist√≥rico.</p>`;
    return;
  }

  if (!registros || registros.length === 0) {
    container.innerHTML = `<p style="color:#666;">Nenhum apontamento encontrado.</p>`;
    return;
  }

  let html = `
    <table style="width:100%; border-collapse:collapse; font-size:13px;">
      <thead>
        <tr>
          <th>F√°brica</th>
          <th>Fornecedor</th>
          <th>Obra</th>
          <th>Instala√ß√£o</th>
          <th>Estrutura</th>
          <th>Conjunto</th>
          <th>Qtd</th>
        </tr>
      </thead>
      <tbody>
  `;

  registros.forEach(r => {
    html += `
      <tr>
        <td>${r.fabrica}</td>
        <td>${r.fornecedor}</td>
        <td>${r.obra}</td>
        <td>${r.instalacao}</td>
        <td>${r.estrutura}</td>
        <td>${r.conjunto}</td>
        <td>${r.quantidade}</td>
      </tr>
    `;
  });

  html += `</tbody></table>`;

  container.innerHTML = html;
}

/* ============================
   FINALIZAR
============================ */

function abrirModalDuplicidade(registroBanco, registroAtual) {
  return new Promise((resolve) => {

    const modal = document.getElementById("modalDuplicidade");
    const conteudo = document.getElementById("conteudoDuplicidade");

    conteudo.innerHTML = `
      <div style="flex:1; min-width:300px;">
        <h4>Registro j√° existente no banco</h4>
        <p><strong>Data:</strong> ${registroBanco.data}</p>
        <p><strong>Processo:</strong> ${registroBanco.processo}</p>
        <p><strong>F√°brica:</strong> ${registroBanco.fabrica}</p>
        <p><strong>Fornecedor:</strong> ${registroBanco.fornecedor}</p>
        <p><strong>Obra:</strong> ${registroBanco.obra}</p>
        <p><strong>Instala√ß√£o:</strong> ${registroBanco.instalacao}</p>
        <p><strong>Estrutura:</strong> ${registroBanco.estrutura}</p>
        <p><strong>Conjunto:</strong> ${registroBanco.conjunto}</p>
        <p><strong>Quantidade:</strong> ${registroBanco.quantidade}</p>
      </div>

      <div style="flex:1; min-width:300px;">
        <h4>Registro que est√° sendo lan√ßado</h4>
        <p><strong>Data:</strong> ${registroAtual.data}</p>
        <p><strong>Processo:</strong> ${registroAtual.processo}</p>
        <p><strong>F√°brica:</strong> ${registroAtual.fabrica}</p>
        <p><strong>Fornecedor:</strong> ${registroAtual.fornecedor}</p>
        <p><strong>Obra:</strong> ${registroAtual.obra}</p>
        <p><strong>Instala√ß√£o:</strong> ${registroAtual.instalacao}</p>
        <p><strong>Estrutura:</strong> ${registroAtual.estrutura}</p>
        <p><strong>Conjunto:</strong> ${registroAtual.conjunto}</p>
        <p><strong>Quantidade:</strong> ${registroAtual.quantidade}</p>
      </div>
    `;

    modal.style.display = "flex";

    document.getElementById("btnCancelarDuplicidade").onclick = () => {
      modal.style.display = "none";
      resolve(false);
    };

    document.getElementById("btnConfirmarDuplicidade").onclick = () => {
      modal.style.display = "none";
      resolve(true);
    };

  });
}

async function validarEFinalizar() {

  if (!data.value) {
    alert("Informe a data.");
    return;
  }

  if (!processo.value) {
    alert("Selecione o processo.");
    return;
  }

  if (fabrica.value.trim() === "") {
    alert("Informe a f√°brica.");
    return;
  }

  if (fornecedor.value.trim() === "") {
    alert("Informe o fornecedor.");
    return;
  }

  const linhas = tbody.querySelectorAll("tr");

  if (linhas.length === 0) {
    alert("Adicione ao menos uma linha.");
    return;
  }

  registrosPendentes = [];
  const controleDuplicidade = new Set();

  for (const tr of linhas) {

    const equipe = tr.querySelector(".equipe").value;
    const obra = tr.querySelector(".obra").value;
    const instalacao = tr.querySelector(".instalacao").value;
    const estrutura = tr.querySelector(".estrutura").value;
    const conjunto = tr.querySelector(".conjunto").value;
    const descricao = tr.querySelector(".descricao").value;
    const quantidade = Number(tr.querySelector(".quantidade").value);

    // ===== VALIDA√á√ÉO CAMPOS OBRIGAT√ìRIOS =====
    if (
      equipe.trim() === "" ||
      obra.trim() === "" ||
      instalacao.trim() === "" ||
      estrutura.trim() === "" ||
      conjunto.trim() === ""
    ) {
      alert("Todos os campos da linha devem ser preenchidos.");
      return;
    }


    if (!descricao) {
      alert("Descri√ß√£o n√£o carregada. Verifique o grupo.");
      return;
    }

    if (!quantidade || quantidade <= 0) {
      alert("Quantidade inv√°lida.");
      return;
    }

    // ===== CONTROLE DE DUPLICIDADE =====
    const chave = [
      obra.trim().toUpperCase(),
      instalacao.trim().toUpperCase(),
      estrutura.trim().toUpperCase(),
      conjunto.trim().toUpperCase(),
      processo.value.trim().toUpperCase()
    ].join("|")

    if (controleDuplicidade.has(chave)) {
      alert("Grupo duplicado na mesma grava√ß√£o.");
      return;
    }

    controleDuplicidade.add(chave);

    registrosPendentes.push({
      _tr: tr, //refer√™ncia da linha
      data: data.value,
      processo: processo.value,
      equipe,
      obra,
      instalacao,
      estrutura,
      conjunto,
      descricao,
      quantidade,
      fabrica: fabrica.value,
      fornecedor: fornecedor.value
    });
  }

  // ===== VERIFICA DUPLICIDADE NO BANCO =====

  let linhasDuplicadas = [];
  let registroBancoDuplicado = null;

  for (const registro of registrosPendentes) {

    const { data: existente, error: erroConsulta } = await supabase
      .from("apontamentos")
      .select("data, processo, fabrica, fornecedor, obra, instalacao, estrutura, conjunto, quantidade")
      .eq("data", registro.data)
      .eq("processo", registro.processo)
      .eq("fabrica", registro.fabrica)
      .eq("fornecedor", registro.fornecedor)
      .eq("obra", registro.obra)
      .eq("instalacao", registro.instalacao)
      .eq("estrutura", registro.estrutura)
      .eq("conjunto", registro.conjunto)
      .limit(1);

    if (erroConsulta) {
      alert("Erro ao verificar duplicidade no banco.");
      return;
    }

    if (existente && existente.length > 0) {
      linhasDuplicadas.push(registro._tr);
      registroBancoDuplicado = existente[0];
    }
  }

  // Remove destaque antigo
  tbody.querySelectorAll("tr").forEach(tr => {
    tr.style.backgroundColor = "";
    tr.style.border = "";
  });

  if (linhasDuplicadas.length > 0) {

   // Destaca linhas duplicadas
    linhasDuplicadas.forEach(tr => {
      tr.style.backgroundColor = "#ffe5e5";
      tr.style.border = "2px solid red";
    });

    let mensagem = "Duplicidade de lan√ßamento no banco de dados!\n\n";

    if (registroBancoDuplicado) {
      mensagem += "Registro j√° existente:\n\n";
      mensagem += `Data: ${registroBancoDuplicado.data}\n`;
      mensagem += `Processo: ${registroBancoDuplicado.processo}\n`;
      mensagem += `F√°brica: ${registroBancoDuplicado.fabrica}\n`;
      mensagem += `Fornecedor: ${registroBancoDuplicado.fornecedor}\n`;
      mensagem += `Obra: ${registroBancoDuplicado.obra}\n`;
      mensagem += `Instala√ß√£o: ${registroBancoDuplicado.instalacao}\n`;
      mensagem += `Estrutura: ${registroBancoDuplicado.estrutura}\n`;
      mensagem += `Conjunto: ${registroBancoDuplicado.conjunto}\n`;
      mensagem += `Quantidade j√° lan√ßada: ${registroBancoDuplicado.quantidade}\n\n`;
    }

    mensagem += "Deseja continuar com o salvamento?";

    const continuar = await abrirModalDuplicidade(
      registroBancoDuplicado,
      registrosPendentes[0]
    );

    if (!continuar) {
      return;
    }
  }

  // ===== INSERE AP√ìS CONFIRMA√á√ÉO =====

  const registrosParaSalvar = registrosPendentes.map(r => {
    const { _tr, ...dados } = r;
    return dados;
  });

  const { error: erroInsert } = await supabase
    .from("apontamentos")
    .insert(registrosParaSalvar);

  if (erroInsert) {
    alert("Erro ao salvar: " + erroInsert.message);
    return;
  }

  alert("Apontamento salvo com sucesso!");
  tbody.innerHTML = "";
  addLinha();
  carregarHistorico();

}

window.addLinha = addLinha;
window.validarEFinalizar = validarEFinalizar;

data.addEventListener("change", carregarHistorico);
processo.addEventListener("change", carregarHistorico);

addLinha();

</script>

<div id="modalDuplicidade" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.4); z-index:9999; align-items:center; justify-content:center;">
  <div style="background:#fff; width:90%; max-width:900px; border-radius:8px; padding:20px; box-shadow:0 4px 15px rgba(0,0,0,0.3);">

    <h3 style="margin-top:0;">Duplicidade de lan√ßamento detectada</h3>

    <div id="conteudoDuplicidade" style="display:flex; gap:20px; flex-wrap:wrap;"></div>

    <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:20px;">
      <button id="btnCancelarDuplicidade" style="background:#d9534f; color:white; border:none; padding:10px 15px; border-radius:4px;">Cancelar</button>
      <button id="btnConfirmarDuplicidade" style="background:#2e7d32; color:white; border:none; padding:10px 15px; border-radius:4px;">Continuar Salvamento</button>
    </div>

  </div>
</div>

</body>
</html>
