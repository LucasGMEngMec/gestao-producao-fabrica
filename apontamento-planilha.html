<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>Apontamento de Produ√ß√£o</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body { font-family: Arial, sans-serif; margin: 10px; background: #f4f6f8; }
h2 { text-align: center; }

.topo, .tabela {
  background: #fff;
  padding: 12px;
  border-radius: 6px;
  margin-bottom: 12px;
  box-shadow: 0 1px 4px rgba(0,0,0,0.1);
}

.linha-topo {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
  gap: 10px;
}

label { font-size: 13px; font-weight: bold; }

input, select {
  width: 100%;
  padding: 10px;
  font-size: 15px;
  box-sizing: border-box;
}

table {
  width: 100%;
  border-collapse: collapse;
  font-size: 13px;
}

th, td {
  border: 1px solid #ccc;
  padding: 6px;
}

th { background: #eee; white-space: nowrap; }

.acoes {
  margin-top: 10px;
  display: flex;
  gap: 10px;
}

.acoes button {
  padding: 12px;
  flex: 1;
  font-size: 15px;
  border: none;
  border-radius: 4px;
  cursor: pointer;
}

.add { background: #0275d8; color: white; }
.finalizar { background: #2e7d32; color: white; }
.remover {
  background: #d9534f;
  color: white;
  border: none;
  padding: 6px 10px;
  cursor: pointer;
  border-radius: 4px;
}

/* RESPONSIVO MOBILE */
@media (max-width: 768px) {

  table thead { display: none; }

  table, tbody, tr, td {
    display: block;
    width: 100%;
  }

  tr {
    margin-bottom: 12px;
    background: #fff;
    padding: 10px;
    border-radius: 6px;
  }

  td {
    border: none;
    margin-bottom: 8px;
  }

  .acoes {
    position: sticky;
    bottom: 0;
    background: #fff;
    padding: 10px;
  }
}
</style>
</head>

<body>

<h2>Apontamento de Produ√ß√£o</h2>

<div class="topo">
  <div class="linha-topo">
    <div><label>Data</label><input type="date" id="data"></div>

    <div>
      <label>Processo</label>
      <select id="processo">
        <option value="">Selecione</option>
        <option>Montagem</option>
        <option>Soldagem</option>
        <option>Acabamento</option>
        <option>Pintura</option>
        <option>Entrega</option>
      </select>
    </div>

    <div><label>F√°brica</label><input id="fabrica"></div>
    <div><label>Fornecedor</label><input id="fornecedor"></div>
  </div>
</div>

<div class="tabela">
<table id="grid">
<thead>
<tr>
<th>Equipe</th>
<th>Obra</th>
<th>Instala√ß√£o</th>
<th>Estrutura</th>
<th>Conjunto</th>
<th>Descri√ß√£o</th>
<th>Qtde</th>
<th>J√° Produzido</th>
<th>A√ß√£o</th>
</tr>
</thead>
<tbody></tbody>
</table>

<div class="acoes">
<button class="add" onclick="addLinha()">+ Linha</button>
<button class="finalizar" onclick="validarEFinalizar()">Finalizar</button>
</div>
</div>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

const supabase = createClient(
  "https://dklmejmlovtcadlicnhu.supabase.co",
  "sb_publishable_cpq_meWiczl3c9vpmtKj0w_QOAzH2At"
);

const tbody = document.querySelector("#grid tbody");
let registrosPendentes = [];

/* ============================
   UTIL
============================ */
function unique(arr) {
  return [...new Set(arr.filter(Boolean))];
}

function preencherSelect(select, valores, placeholder="Selecione") {
  select.innerHTML = `<option value="">${placeholder}</option>`;
  unique(valores).forEach(v => {
    const opt = document.createElement("option");
    opt.value = v;
    opt.textContent = v;
    select.appendChild(opt);
  });
  select.disabled = false;
}

function resetSelect(select) {
  select.innerHTML = `<option value="">Selecione</option>`;
  select.disabled = true;
}

/* ============================
   CARREGAR EQUIPES + OBRAS
============================ */
async function carregarBase(tr) {

  const selEquipe = tr.querySelector(".equipe");
  const selObra = tr.querySelector(".obra");

  const { data: equipes } = await supabase
    .from("equipes_producao")
    .select("nome");

  preencherSelect(selEquipe, equipes.map(e => e.nome));

  const { data: obras } = await supabase
    .from("grupos_producao")
    .select("obra");

  preencherSelect(selObra, obras.map(o => o.obra));
}

/* ============================
   LINHA
============================ */
function addLinha() {

  const tr = document.createElement("tr");
  tr.innerHTML = `
    <td><select class="equipe"></select></td>
    <td><select class="obra"></select></td>
    <td><select class="instalacao" disabled></select></td>
    <td><select class="estrutura" disabled></select></td>
    <td><select class="conjunto" disabled></select></td>
    <td><input class="descricao" disabled></td>
    <td><input type="number" class="quantidade" min="1"></td>
    <td><input class="produzido" disabled value="0"></td>
    <td><button class="remover" onclick="this.closest('tr').remove()">üóëÔ∏è</button></td>
  `;

  tbody.appendChild(tr);
  configurarEventos(tr);
  carregarBase(tr);
}

/* ============================
   EVENTOS CASCADE
============================ */
function configurarEventos(tr) {

  const obra = tr.querySelector(".obra");
  const instalacao = tr.querySelector(".instalacao");
  const estrutura = tr.querySelector(".estrutura");
  const conjunto = tr.querySelector(".conjunto");
  const descricao = tr.querySelector(".descricao");

  obra.addEventListener("change", async () => {

    resetSelect(instalacao);
    resetSelect(estrutura);
    resetSelect(conjunto);
    descricao.value = "";

    if (!obra.value) return;

    const { data } = await supabase
      .from("grupos_producao")
      .select("instalacao")
      .eq("obra", obra.value);

    preencherSelect(instalacao, data.map(d => d.instalacao));
  });

  instalacao.addEventListener("change", async () => {

    resetSelect(estrutura);
    resetSelect(conjunto);
    descricao.value = "";

    if (!instalacao.value) return;

    const { data } = await supabase
      .from("grupos_producao")
      .select("estrutura")
      .eq("obra", obra.value)
      .eq("instalacao", instalacao.value);

    preencherSelect(estrutura, data.map(d => d.estrutura));
  });

  estrutura.addEventListener("change", async () => {

    resetSelect(conjunto);
    descricao.value = "";

    if (!estrutura.value) return;

    const { data } = await supabase
      .from("grupos_producao")
      .select("conjunto")
      .eq("obra", obra.value)
      .eq("instalacao", instalacao.value)
      .eq("estrutura", estrutura.value);

    preencherSelect(conjunto, data.map(d => d.conjunto));
  });

  conjunto.addEventListener("change", async () => {

    if (!conjunto.value) return;

    const { data } = await supabase
      .from("grupos_producao")
      .select("descricao")
      .eq("obra", obra.value)
      .eq("instalacao", instalacao.value)
      .eq("estrutura", estrutura.value)
      .eq("conjunto", conjunto.value)
      .limit(1);

    if (data?.length) descricao.value = data[0].descricao;
  });
}

/* ============================
   FINALIZAR
============================ */
async function validarEFinalizar() {

  if (!data.value || !processo.value) {
    alert("Preencha Data e Processo.");
    return;
  }

  registrosPendentes = [];

  for (const tr of tbody.querySelectorAll("tr")) {

    const quantidade = Number(tr.querySelector(".quantidade").value);

    if (!quantidade || quantidade <= 0) {
      alert("Quantidade inv√°lida.");
      return;
    }

    registrosPendentes.push({
      data: data.value,
      processo: processo.value,
      equipe: tr.querySelector(".equipe").value,
      obra: tr.querySelector(".obra").value,
      instalacao: tr.querySelector(".instalacao").value,
      estrutura: tr.querySelector(".estrutura").value,
      conjunto: tr.querySelector(".conjunto").value,
      descricao: tr.querySelector(".descricao").value,
      quantidade,
      fabrica: fabrica.value,
      fornecedor: fornecedor.value
    });
  }

  const { error } = await supabase
    .from("apontamentos")
    .insert(registrosPendentes);

  if (error) {
    alert("Erro ao salvar: " + error.message);
    return;
  }

  alert("Apontamento salvo com sucesso!");
  tbody.innerHTML = "";
  addLinha();
}

window.addLinha = addLinha;
window.validarEFinalizar = validarEFinalizar;

addLinha();
</script>

</body>
</html>
