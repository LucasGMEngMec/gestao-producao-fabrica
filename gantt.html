/*************************************************
 * SUPABASE CLIENT (VERSÃO ÚNICA E CORRETA)*
 *************************************************/
const SUPABASE_URL = "https://dklmejmlovtcadlicnhu.supabase.co";
const SUPABASE_KEY =
  "sb_publishable_cpq_meWiczl3c9vpmtKj0w_QOAzH2At";

const supabaseClient = window.supabase.createClient(
  SUPABASE_URL,
  SUPABASE_KEY
);

/*************************************************
 * CONSTANTES E VARIÁVEIS
 *************************************************/
const gantt = document.getElementById("gantt");
const btnSalvar = document.getElementById("btnSalvar");
const DAY_WIDTH = 40;

let itens = [];
let inicioGlobal = null;

/*************************************************
 * FUNÇÕES DE DATA
 *************************************************/
function parseDate(d) {
  return new Date(d + "T00:00:00");
}

function diffDays(a, b) {
  return Math.round((b - a) / 86400000);
}

/*************************************************
 * CARREGAR DADOS DO SUPABASE
 *************************************************/
async function carregarDados() {
  gantt.innerHTML = "";

  const { data, error } = await supabaseClient
    .from("cronograma_estrutura")
    .select("*")
    .order("instalacao");

  if (error) {
    console.error(error);
    alert("Erro ao carregar dados do Supabase");
    return;
  }

  itens = data;

  /* ===== DATA INICIAL GLOBAL ===== */
  inicioGlobal = new Date();

  itens.forEach(i => {
    if (i.data_inicio_plan) {
      const d = parseDate(i.data_inicio_plan);
      if (d < inicioGlobal) inicioGlobal = d;
    }
  });

  criarTimeline();
  itens.forEach(criarEstrutura);
}

/*************************************************
 * TIMELINE (ANO / MÊS / DIA)
 *************************************************/
function criarTimeline() {
  const container = document.createElement("div");

  const linhaAno = document.createElement("div");
  const linhaMes = document.createElement("div");
  const linhaDia = document.createElement("div");

  linhaAno.className = "timeline";
  linhaMes.className = "timeline";
  linhaDia.className = "timeline";

  let anoAtual = null;
  let mesAtual = null;

  for (let i = 0; i < 120; i++) {
    const d = new Date(inicioGlobal);
    d.setDate(d.getDate() + i);

    /* ===== ANO ===== */
    const anoDiv = document.createElement("div");
    anoDiv.className = "day";
    anoDiv.innerText = d.getFullYear() !== anoAtual ? d.getFullYear() : "";
    linhaAno.appendChild(anoDiv);
    anoAtual = d.getFullYear();

    /* ===== MÊS ===== */
    const mesDiv = document.createElement("div");
    mesDiv.className = "day";
    mesDiv.innerText =
      d.getMonth() !== mesAtual
        ? d.toLocaleString("pt-BR", { month: "short" })
        : "";
    linhaMes.appendChild(mesDiv);
    mesAtual = d.getMonth();

    /* ===== DIA ===== */
    const diaDiv = document.createElement("div");
    diaDiv.className = "day";
    diaDiv.innerText = d.getDate();
    linhaDia.appendChild(diaDiv);
  }

  container.appendChild(linhaAno);
  container.appendChild(linhaMes);
  container.appendChild(linhaDia);
  gantt.appendChild(container);
}

/*************************************************
 * CRIAÇÃO DAS LINHAS DO GANTT
 *************************************************/
function criarEstrutura(item) {
  const inicioPlan =
    item.data_inicio_plan ||
    new Date().toISOString().slice(0, 10);

  criarLinha(item, "plan", inicioPlan, item.duracao_planejada_dias);

  if (item.data_inicio_real)
    criarLinha(
      item,
      "real",
      item.data_inicio_real,
      item.duracao_planejada_dias
    );

  if (item.data_fim_forecast) {
    const inicio = item.data_inicio_real || inicioPlan;
    criarLinha(
      item,
      "forecast",
      inicio,
      diffDays(parseDate(inicio), parseDate(item.data_fim_forecast))
    );
  }
}

function criarLinha(item, tipo, inicio, duracao) {
  if (!inicio || !duracao) return;

  const row = document.createElement("div");
  row.className = "row";

  const label = document.createElement("div");
  label.className = "label";
  label.innerHTML = `
    <b>${item.estrutura}</b><br>
    ${item.instalacao}
  `;

  const area = document.createElement("div");
  area.className = "bar-area";

  const bar = document.createElement("div");
  bar.className = `bar ${tipo}`;
  bar.innerText = tipo.toUpperCase();

  const inicioDate = parseDate(inicio);

  bar.style.left =
    diffDays(inicioGlobal, inicioDate) * DAY_WIDTH + "px";
  bar.style.width = duracao * DAY_WIDTH + "px";

  area.appendChild(bar);
  row.appendChild(label);
  row.appendChild(area);
  gantt.appendChild(row);
}

/*************************************************
 * SALVAR (PLACEHOLDER FUNCIONAL)
 *************************************************/
btnSalvar.onclick = async () => {
  alert("Salvar acionado (persistência pode ser expandida)");
};

/*************************************************
 * INIT
 *************************************************/
carregarDados();
