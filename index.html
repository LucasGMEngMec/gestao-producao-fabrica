<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>Gest칚o de Produ칞칚o</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body {
  font-family: Arial, sans-serif;
  background: #f2f2f2;
  padding: 40px;
}

.topbar {
  display: flex;
  justify-content: flex-end;
  align-items: center;
  background: #2e7d32;
  padding: 10px 20px;
  position: relative;
}

.user-menu {
  position: relative;
}

.user-trigger {
  display: flex;
  align-items: center;
  cursor: pointer;
  gap: 10px;
}

.user-trigger img {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  object-fit: cover;
  border: 2px solid white;
}

.user-info {
  color: white;
  font-size: 14px;
}

.dropdown {
  position: absolute;
  right: 0;
  top: 55px;
  background: white;
  border-radius: 6px;
  box-shadow: 0 4px 10px rgba(0,0,0,0.2);
  display: none;
  flex-direction: column;
  min-width: 180px;
  overflow: hidden;
}

.dropdown button {
  padding: 10px;
  border: none;
  background: white;
  text-align: left;
  cursor: pointer;
}

.dropdown button:hover {
  background: #f2f2f2;
}

.menu {
  max-width: 400px;
  margin: auto;
  background: #fff;
  border: 1px solid #cfcfcf;
  padding: 20px;
}

h2 {
  text-align: center;
}

a {
  display: block;
  padding: 12px;
  margin-top: 10px;
  text-align: center;
  text-decoration: none;
  background: #0070c0;
  color: #fff;
  font-size: 16px;
}

a.grupos {
  background: #2e7d32;
}
</style>

</head>

<body>

<div class="topbar">
  <div class="user-menu">
    <div class="user-trigger" onclick="toggleUserMenu()">
      <img id="userAvatar" src="https://via.placeholder.com/40" />
      <div class="user-info">
        <span id="usuarioInfo"></span>
      </div>
    </div>

    <div class="dropdown" id="userDropdown">
      <button onclick="abrirPerfil()">Perfil do Usu치rio</button>
      <button onclick="logout()">Log Off</button>
    </div>
  </div>
</div>

<div class="menu">
  <h2>Gest칚o de Produ칞칚o</h2>

  <a href="apontamento-planilha.html">
    Apontamento de Produ칞칚o
  </a>

  <a id="linkGrupos" class="grupos" href="grupos.html">
    Cadastro de Grupos
  </a>

  <a id="linkEquipes" class="grupos" href="equipes.html">
    Cadastro de Equipes
  </a>

  <a id="linkCronograma" class="grupos" href="cronograma.html">
    Cadastro de Cronograma
  </a>

  <a id="linkGantt" class="grupos" href="gantt.html">
    Cronograma de Produ칞칚o
  </a>

  <a id="linkUsuarios" class="grupos" href="usuarios.html">
    Administra칞칚o de Usu치rios
  </a>
</div>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

const supabase = createClient(
  "https://dklmejmlovtcadlicnhu.supabase.co",
  "sb_publishable_cpq_meWiczl3c9vpmtKj0w_QOAzH2At"
);

// 游댏 Verifica sess칚o
const { data: { user } } = await supabase.auth.getUser();

if (!user) {
  window.location.href = "login.html";
}

// 游댍 Busca perfil
const { data, error } = await supabase
  .from("usuarios_perfil")
  .select("nome, perfil, ativo")
  .eq("id", user.id)
  .single();

if (error) {
    console.error("Erro ao buscar perfil:", error);
    alert("Erro ao carregar perfil do usu치rio.");
    window.location.href = "login.html";
  }

if (!data) {
  alert("Perfil n칚o encontrado. Contate o administrador.");
  window.location.href = "login.html";
}

const usuarioLogado = {
  id: user.id,
  nome: data?.nome || user.email,
  perfil: data?.perfil || "operador",
  ativo: data?.ativo ?? true
};

if (!usuarioLogado.ativo) {
  alert("Usu치rio inativo.");
  await supabase.auth.signOut();
  window.location.href = "login.html";
}

// 游댏 Helper permiss칚o
function temPermissao(perfisPermitidos) {
  return perfisPermitidos.includes(usuarioLogado.perfil);
}

// 游녻 Exibir usu치rio
document.getElementById("usuarioInfo").innerText =
usuarioLogado.nome + " - " + usuarioLogado.perfil.toUpperCase();

  // Dropdown usu치rio
window.toggleUserMenu = function () {
  const menu = document.getElementById("userDropdown");
  menu.style.display = menu.style.display === "flex" ? "none" : "flex";
};

// Fecha menu ao clicar fora
document.addEventListener("click", function (e) {
  const menu = document.getElementById("userDropdown");
  const trigger = document.querySelector(".user-trigger");

  if (!trigger.contains(e.target)) {
    menu.style.display = "none";
  }
});

// Abrir p치gina perfil
window.abrirPerfil = function () {
  window.location.href = "perfil.html";
};

// 游꿢 MENU DIN츽MICO

// Supervisor e Admin veem equipes
if (!temPermissao(["admin","supervisor"])) {
  document.getElementById("linkEquipes").style.display = "none";
}

// Somente Admin v칡 grupos e cronograma
if (!temPermissao(["admin"])) {
  document.getElementById("linkGrupos").style.display = "none";
  document.getElementById("linkCronograma").style.display = "none";
  document.getElementById("linkGantt").style.display = "none";
}

// Somente Admin v칡 painel de usu치rios
if (!temPermissao(["admin"])) {
  document.getElementById("linkUsuarios").style.display = "none";
}

// 游뛁 Logout
window.logout = async function () {
  await supabase.auth.signOut();
  window.location.href = "login.html";
};
</script>

</body>
</html>
