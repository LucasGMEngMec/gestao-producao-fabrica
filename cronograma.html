<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>Cronograma de Produ√ß√£o</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body { font-family: Arial, sans-serif; margin: 10px; background: #f4f6f8; }
h2 { text-align: center; }

.bloco {
  background: #fff;
  padding: 12px;
  border-radius: 6px;
  margin-bottom: 12px;
  box-shadow: 0 1px 4px rgba(0,0,0,0.1);
}

table {
  width: 100%;
  border-collapse: collapse;
  font-size: 13px;
}

th, td {
  border: 1px solid #ccc;
  padding: 6px;
}

th { background: #eee; white-space: nowrap; }

td select, td input {
  width: 100%;
  border: none;
  outline: none;
  background: transparent;
}

.acoes {
  margin-top: 10px;
  display: flex;
  gap: 10px;
}

button {
  padding: 10px;
  flex: 1;
  font-size: 14px;
  border: none;
  border-radius: 4px;
  cursor: pointer;
}

.add { background: #0275d8; color: white; }
.salvar { background: #2e7d32; color: white; }
.remover { background: #d9534f; color: white; }
</style>
</head>

<body>

<h2>Cronograma de Produ√ß√£o ‚Äî Planejamento</h2>

<div class="bloco">
<table id="grid">
  <thead>
    <tr>
      <th>F√°brica</th>
      <th>Fornecedor</th>
      <th>Obra</th>
      <th>Instala√ß√£o</th>
      <th>Estrutura</th>
      <th>Dura√ß√£o (dias √∫teis)</th>
      <th>Data de in√≠cio</th>
      <th>A√ß√£o</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<div class="acoes">
  <button class="add" id="btnAdd">+ Linha</button>
  <button class="salvar" id="btnSalvar">Salvar Cronograma</button>
</div>
</div>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

const supabase = createClient(
  "https://dklmejmlovtcadlicnhu.supabase.co",
  "sb_publishable_cpq_meWiczl3c9vpmtKj0w_QOAzH2At"
);

// üîê Verifica sess√£o
const { data: { user } } = await supabase.auth.getUser();

if (!user) {
  window.location.href = "login.html";
}

// üîé Busca perfil
const { data } = await supabase
  .from("usuarios_perfil")
  .select("nome, perfil, ativo")
  .eq("id", user.id)
  .single();

const usuarioLogado = {
  id: user.id,
  nome: data?.nome || user.email,
  perfil: data?.perfil || "operador",
  ativo: data?.ativo ?? true
};

if (!usuarioLogado.ativo) {
  alert("Usu√°rio inativo.");
  await supabase.auth.signOut();
  window.location.href = "login.html";
}

if (usuarioLogado.perfil !== "admin") {
  alert("Acesso restrito a administradores.");
  window.location.href = "index.html";
}

const tbody = document.querySelector("#grid tbody");

let listas = {
  fabricas: [],
  fornecedores: [],
  obras: [],
  instalacoes: [],
  estruturas: []
};

async function carregarListas() {

  const { data: apont } = await supabase
    .from("apontamentos")
    .select("fabrica, fornecedor");

  listas.fabricas = [...new Set(apont.map(a => a.fabrica).filter(Boolean))];
  listas.fornecedores = [...new Set(apont.map(a => a.fornecedor).filter(Boolean))];

  const { data: grupos } = await supabase
    .from("grupos_producao")
    .select("obra, instalacao, estrutura");

  listas.obras = [...new Set(grupos.map(g => g.obra))];
  listas.instalacoes = [...new Set(grupos.map(g => g.instalacao))];
  listas.estruturas = [...new Set(grupos.map(g => g.estrutura))];
}

function selectHTML(valores) {
  return `
    <select>
      <option value="">Selecione</option>
      ${valores.map(v => `<option>${v}</option>`).join("")}
    </select>
  `;
}

function addLinha() {
  const tr = document.createElement("tr");
  tr.innerHTML = `
    <td>${selectHTML(listas.fabricas)}</td>
    <td>${selectHTML(listas.fornecedores)}</td>
    <td>${selectHTML(listas.obras)}</td>
    <td>${selectHTML(listas.instalacoes)}</td>
    <td>${selectHTML(listas.estruturas)}</td>
    <td><input type="number" min="1"></td>
    <td><input type="date"></td>
    <td><button class="remover">üóëÔ∏è</button></td>
  `;
  tr.querySelector(".remover").onclick = () => tr.remove();
  tbody.appendChild(tr);
}

async function salvarCronograma() {

  const registros = [];

  for (const tr of tbody.querySelectorAll("tr")) {
    const selects = tr.querySelectorAll("select");
    const duracao = tr.querySelector('input[type="number"]');
    const dataInicio = tr.querySelector('input[type="date"]');

    if (
      ![...selects].every(s => s.value) ||
      !duracao.value ||
      !dataInicio.value
    ) {
      alert("Preencha todas as c√©lulas.");
      return;
    }

    registros.push({
      fabrica: selects[0].value,
      fornecedor: selects[1].value,
      obra: selects[2].value,
      instalacao: selects[3].value,
      estrutura: selects[4].value,
      duracao_planejada_dias: Number(duracao.value),
      data_inicio_plan: dataInicio.value
    });
  }

  const { error } = await supabase
    .from("cronograma_estrutura")
    .insert(registros);

  if (error) {
    alert("Erro ao salvar: " + error.message);
    return;
  }

  alert("Cronograma salvo com sucesso!");
  tbody.innerHTML = "";
  addLinha();
}

document.getElementById("btnAdd").addEventListener("click", addLinha);
document.getElementById("btnSalvar").addEventListener("click", salvarCronograma);

await carregarListas();
addLinha();
</script>

</body>
</html>
